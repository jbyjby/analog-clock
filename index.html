<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아날로그 시계</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8 overflow-hidden">
    <div class="bg-white rounded-3xl shadow-2xl p-8 relative">
        <button
            id="captureBtn"
            class="absolute top-6 right-6 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 active:bg-indigo-800 transition-colors shadow-md"
        >
            📸 캡처
        </button>

        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            아날로그 시계
        </h1>

        <div
            id="clockContainer"
            class="relative w-80 h-80 mb-8 select-none"
        >
            <div id="clock" class="w-full h-full">
                <!-- SVG 시계 배경 -->
                <svg class="absolute inset-0 w-full h-full" viewBox="0 0 320 320">
                    <!-- 시계 테두리 -->
                    <circle cx="160" cy="160" r="156" fill="white" stroke="#1f2937" stroke-width="8"/>

                    <!-- 분 눈금 -->
                    <g id="ticks"></g>
                </svg>

                <!-- 시계 숫자 -->
                <div id="numbers"></div>

                <!-- 중심점 -->
                <div class="absolute left-1/2 top-1/2 w-4 h-4 bg-red-500 rounded-full transform -translate-x-1/2 -translate-y-1/2 z-30"></div>

                <!-- 분침 -->
                <div
                    id="minuteHand"
                    class="absolute left-1/2 bottom-1/2 w-2 bg-blue-600 origin-bottom rounded-t-full cursor-grab active:cursor-grabbing z-10"
                    style="height: 120px; transform: translateX(-50%) rotate(0deg); transition: transform 0.3s ease;"
                ></div>

                <!-- 시침 -->
                <div
                    id="hourHand"
                    class="absolute left-1/2 bottom-1/2 w-2 bg-gray-800 origin-bottom rounded-t-full z-20"
                    style="height: 80px; transform: translateX(-50%) rotate(0deg); transition: transform 0.3s ease;"
                ></div>
            </div>
        </div>

        <div class="text-center space-y-3 mb-6">
            <div id="digitalTime" class="text-3xl font-semibold text-gray-800">
                12시 0분
            </div>
            <div id="koreanTime" class="text-3xl font-semibold text-indigo-600">
                12시 정각
            </div>
            <div class="text-sm text-gray-500 mt-4">
                💡 파란 분침을 드래그해서 시간을 조정하세요!
            </div>
        </div>
    </div>

    <script>
        let totalMinutes = 0;
        let isDragging = false;
        let lastAngle = null;

        const clock = document.getElementById('clock');
        const clockContainer = document.getElementById('clockContainer');
        const minuteHand = document.getElementById('minuteHand');
        const hourHand = document.getElementById('hourHand');
        const digitalTime = document.getElementById('digitalTime');
        const koreanTime = document.getElementById('koreanTime');
        const captureBtn = document.getElementById('captureBtn');

        function getCurrentHours() {
            return Math.floor(totalMinutes / 60);
        }

        function getCurrentMins() {
            return Math.round(totalMinutes % 60);
        }

        function getDisplayHours() {
            return getCurrentHours() % 12 || 12;
        }

        function getMinuteAngle() {
            return (getCurrentMins() / 60) * 360;
        }

        function getHourAngle() {
            return ((getDisplayHours() + getCurrentMins() / 60) / 12) * 360;
        }

        function getAngleFromMouse(e) {
            const rect = clock.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const mouseX = e.clientX || e.touches?.[0]?.clientX;
            const mouseY = e.clientY || e.touches?.[0]?.clientY;

            const dx = mouseX - centerX;
            const dy = mouseY - centerY;

            let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
            if (angle < 0) angle += 360;

            return angle;
        }

        function getKoreanTime() {
            const h = getDisplayHours();
            const m = getCurrentMins();

            if (m === 0) {
                return `${h}시 정각`;
            } else if (m < 30) {
                return `${h}시 ${m}분`;
            } else if (m === 30) {
                return `${h}시 30분`;
            } else {
                const nextHour = h === 12 ? 1 : h + 1;
                const remaining = 60 - m;
                return `${nextHour}시 ${remaining}분 전`;
            }
        }

        function updateDisplay() {
            const minuteAngle = getMinuteAngle();
            const hourAngle = getHourAngle();

            minuteHand.style.transform = `translateX(-50%) rotate(${minuteAngle}deg)`;
            hourHand.style.transform = `translateX(-50%) rotate(${hourAngle}deg)`;

            digitalTime.textContent = `${getDisplayHours()}시 ${getCurrentMins()}분`;
            koreanTime.textContent = getKoreanTime();
        }

        function handleMouseDown(e) {
            e.stopPropagation();
            e.preventDefault();
            isDragging = true;
            lastAngle = getAngleFromMouse(e);

            minuteHand.style.transition = 'none';
            hourHand.style.transition = 'none';
            clockContainer.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging || lastAngle === null) return;

            e.preventDefault();

            const angle = getAngleFromMouse(e);
            let delta = angle - lastAngle;

            if (delta > 180) {
                delta -= 360;
            } else if (delta < -180) {
                delta += 360;
            }

            const minutesDelta = (delta / 360) * 60;
            totalMinutes += minutesDelta;

            if (totalMinutes < 0) {
                totalMinutes += 720;
            }

            lastAngle = angle;
            updateDisplay();
        }

        function handleMouseUp() {
            isDragging = false;
            lastAngle = null;

            minuteHand.style.transition = 'transform 0.3s ease';
            hourHand.style.transition = 'transform 0.3s ease';
            clockContainer.style.cursor = 'default';
        }

        function createTicks() {
            const ticksGroup = document.getElementById('ticks');

            for (let i = 0; i < 60; i++) {
                const isBigTick = i % 5 === 0;
                const angle = i * 6;
                const length = isBigTick ? 12 : 6;
                const width = isBigTick ? 2.5 : 1.5;
                const startR = 152 - length;
                const endR = 152;

                const x1 = 160 + startR * Math.sin((angle * Math.PI) / 180);
                const y1 = 160 - startR * Math.cos((angle * Math.PI) / 180);
                const x2 = 160 + endR * Math.sin((angle * Math.PI) / 180);
                const y2 = 160 - endR * Math.cos((angle * Math.PI) / 180);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', '#374151');
                line.setAttribute('stroke-width', width);
                line.setAttribute('stroke-linecap', 'round');

                ticksGroup.appendChild(line);
            }
        }

        function createNumbers() {
            const numbersContainer = document.getElementById('numbers');

            [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11].forEach((num, idx) => {
                const angle = (idx * 30 - 90) * (Math.PI / 180);
                const x = 140 * Math.cos(angle);
                const y = 140 * Math.sin(angle);

                const numberDiv = document.createElement('div');
                numberDiv.className = 'absolute text-2xl font-bold text-gray-700';
                numberDiv.style.left = '50%';
                numberDiv.style.top = '50%';
                numberDiv.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                numberDiv.textContent = num;

                numbersContainer.appendChild(numberDiv);
            });
        }

        function downloadImage(blob, fileName) {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = URL.createObjectURL(blob);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            alert('✅ 이미지가 다운로드되었습니다!');
        }

        async function handleCapture() {
            console.log('캡처 시작');

            try {
                const canvas = document.createElement('canvas');
                const size = 800;
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');

                // 배경 그리기
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, size, size);

                const centerX = size / 2;
                const centerY = size / 2;
                const radius = size * 0.4;

                // 시계 테두리 그리기
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.stroke();

                // 분 눈금 그리기
                for (let i = 0; i < 60; i++) {
                    const isBigTick = i % 5 === 0;
                    const angle = (i * 6 - 90) * (Math.PI / 180);
                    const length = isBigTick ? 12 : 6;
                    const width = isBigTick ? 2.5 : 1.5;

                    const startR = radius - length;
                    const endR = radius;

                    const x1 = centerX + startR * Math.cos(angle);
                    const y1 = centerY + startR * Math.sin(angle);
                    const x2 = centerX + endR * Math.cos(angle);
                    const y2 = centerY + endR * Math.sin(angle);

                    ctx.strokeStyle = '#374151';
                    ctx.lineWidth = width;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }

                // 시계 숫자 그리기
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11].forEach((num, idx) => {
                    const angle = (idx * 30 - 90) * (Math.PI / 180);
                    const x = centerX + (radius * 0.85) * Math.cos(angle);
                    const y = centerY + (radius * 0.85) * Math.sin(angle);
                    ctx.fillText(num.toString(), x, y);
                });

                // 시침 그리기
                const hourLen = radius * 0.5;
                const hourAngleRad = ((getHourAngle() - 90) * Math.PI) / 180;
                ctx.strokeStyle = '#1f2937';
                ctx.lineWidth = 8;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(
                    centerX + hourLen * Math.cos(hourAngleRad),
                    centerY + hourLen * Math.sin(hourAngleRad)
                );
                ctx.stroke();

                // 분침 그리기
                const minuteLen = radius * 0.75;
                const minuteAngleRad = ((getMinuteAngle() - 90) * Math.PI) / 180;
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(
                    centerX + minuteLen * Math.cos(minuteAngleRad),
                    centerY + minuteLen * Math.sin(minuteAngleRad)
                );
                ctx.stroke();

                // 중심점 그리기
                ctx.fillStyle = '#ef4444';
                ctx.beginPath();
                ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
                ctx.fill();

                // 이미지를 data URL로 변환
                const dataURL = canvas.toDataURL('image/png');

                // iOS/iPadOS 체크
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

                if (isIOS) {
                    // iOS에서는 이미지를 새 창에 표시해서 사용자가 길게 눌러 저장할 수 있도록 함
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                            <head>
                                <title>시계 이미지 - ${getDisplayHours()}시 ${getCurrentMins()}분</title>
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <style>
                                    body {
                                        margin: 0;
                                        padding: 20px;
                                        background: #f3f4f6;
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                                    }
                                    .instructions {
                                        background: white;
                                        padding: 15px;
                                        border-radius: 10px;
                                        margin-bottom: 20px;
                                        text-align: center;
                                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                    }
                                    .instructions h3 {
                                        margin: 0 0 10px 0;
                                        color: #1f2937;
                                    }
                                    .instructions p {
                                        margin: 5px 0;
                                        color: #6b7280;
                                        font-size: 14px;
                                    }
                                    img {
                                        max-width: 100%;
                                        height: auto;
                                        border-radius: 10px;
                                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="instructions">
                                    <h3>📸 사진 저장 방법</h3>
                                    <p>아래 이미지를 <strong>길게 눌러주세요</strong></p>
                                    <p>메뉴에서 <strong>"사진에 저장"</strong>을 선택하세요</p>
                                </div>
                                <img src="${dataURL}" alt="시계 이미지 - ${getDisplayHours()}시 ${getCurrentMins()}분" />
                            </body>
                        </html>
                    `);
                    newWindow.document.close();
                } else {
                    // 안드로이드나 데스크톱에서는 기존 방식 사용
                    canvas.toBlob(async (blob) => {
                        const fileName = `시계_${getDisplayHours()}시${getCurrentMins()}분.png`;

                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/png' })] })) {
                            try {
                                const file = new File([blob], fileName, { type: 'image/png' });
                                await navigator.share({
                                    files: [file],
                                    title: '시계 캡처'
                                });
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    downloadImage(blob, fileName);
                                }
                            }
                        } else {
                            downloadImage(blob, fileName);
                        }
                    }, 'image/png');
                }

            } catch (error) {
                console.error('캡처 실패:', error);
                alert('캡처에 실패했습니다: ' + error.message);
            }
        }

        // 이벤트 리스너
        minuteHand.addEventListener('mousedown', handleMouseDown);
        minuteHand.addEventListener('touchstart', handleMouseDown);

        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);
        window.addEventListener('touchmove', handleMouseMove, { passive: false });
        window.addEventListener('touchend', handleMouseUp);

        captureBtn.addEventListener('click', handleCapture);

        // 초기화
        createTicks();
        createNumbers();
        updateDisplay();
    </script>
</body>
</html>